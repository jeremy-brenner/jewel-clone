// Generated by CoffeeScript 1.9.1
(function() {
  var Cell, Fps, Grid, Input, Jewel, JewelClone, Jewels, Logger,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Grid = (function() {
    function Grid(w, h, jewels) {
      var cell, i, j, len, len1, ref, row;
      this.w = w;
      this.h = h;
      this.jewels = jewels;
      this.cells = this.buildCells();
      this.object = new THREE.Object3D();
      ref = this.cells;
      for (i = 0, len = ref.length; i < len; i++) {
        row = ref[i];
        for (j = 0, len1 = row.length; j < len1; j++) {
          cell = row[j];
          this.object.add(cell.jewel);
        }
      }
    }

    Grid.prototype.buildCells = function() {
      var i, ref, results, x, y;
      results = [];
      for (x = i = 0, ref = this.h; 0 <= ref ? i < ref : i > ref; x = 0 <= ref ? ++i : --i) {
        results.push((function() {
          var j, ref1, results1;
          results1 = [];
          for (y = j = 0, ref1 = this.w; 0 <= ref1 ? j < ref1 : j > ref1; y = 0 <= ref1 ? ++j : --j) {
            results1.push(new Cell(x, y, this.jewels.random()));
          }
          return results1;
        }).call(this));
      }
      return results;
    };

    return Grid;

  })();

  Cell = (function() {
    function Cell(x, y, jewel) {
      this.x = x;
      this.y = y;
      this.jewel = jewel;
      this.jewel.position.x = x + 0.5;
      this.jewel.position.y = y + 0.5;
    }

    return Cell;

  })();

  Fps = (function() {
    function Fps() {
      this.refresh = 1000;
      this.frames = 0;
      this.lasttime = 0;
    }

    Fps.prototype.timeDiff = function(t) {
      return t - this.lasttime;
    };

    Fps.prototype.update = function(t) {
      var fps;
      this.frames++;
      if (this.timeDiff(t) > this.refresh) {
        fps = Math.floor(this.frames / (this.timeDiff(t) / 100000)) / 100;
        document.getElementById('fps').innerText = "fps: " + fps;
        this.frames = 0;
        return this.lasttime = t;
      }
    };

    return Fps;

  })();

  document.addEventListener('deviceready', function() {
    return new JewelClone();
  });

  Input = (function() {
    function Input() {
      this.updateOrientation = bind(this.updateOrientation, this);
      this.touchMove = bind(this.touchMove, this);
      this.touchEnd = bind(this.touchEnd, this);
      this.touchStart = bind(this.touchStart, this);
      this.touching = false;
      this.bindEvents();
      this.start = {
        x: null,
        y: null
      };
      this.move = {
        x: null,
        y: null
      };
      this.orientation = {
        alpha: 0,
        beta: 0,
        gamma: 0
      };
    }

    Input.prototype.bindEvents = function() {
      window.addEventListener('touchstart', this.touchStart);
      window.addEventListener('touchend', this.touchEnd);
      window.addEventListener('touchmove', this.touchMove);
      return window.addEventListener('deviceorientation', this.updateOrientation);
    };

    Input.prototype.debug = function() {
      return document.getElementById('input').innerText = "touching: " + (this.touching.toString()) + "\nstart: " + this.start.x + ", " + this.start.y + "\nmove: " + this.move.x + ", " + this.move.y + "\nalpha: " + this.orientation.alpha + "\nbeta: " + this.orientation.beta + "\ngamma: " + this.orientation.gamma;
    };

    Input.prototype.touchStart = function(e) {
      this.touching = true;
      this.start.x = e.touches[0].screenX * window.devicePixelRatio;
      this.start.y = e.touches[0].screenY * window.devicePixelRatio;
      return this.debug();
    };

    Input.prototype.touchEnd = function(e) {
      this.touching = false;
      return this.debug();
    };

    Input.prototype.touchMove = function(e) {
      this.move.x = e.touches[0].screenX * window.devicePixelRatio;
      this.move.y = e.touches[0].screenY * window.devicePixelRatio;
      return this.debug();
    };

    Input.prototype.updateOrientation = function(orientation) {
      this.orientation.alpha = orientation.alpha || 0;
      this.orientation.gamma = orientation.gamma || 0;
      this.orientation.beta = orientation.beta || 0;
      return this.debug();
    };

    return Input;

  })();

  JewelClone = (function() {
    function JewelClone() {
      this.renderLoop = bind(this.renderLoop, this);
      this.jewelsLoaded = bind(this.jewelsLoaded, this);
      this.logger = new Logger();
      this.logger.log("logger started");
      this.fps = new Fps();
      this.input = new Input();
      this.deviceAlpha = 0;
      this.deviceBeta = 0;
      this.deviceGamma = 0;
      this.logger.log('init three');
      this.initThree();
      this.jewels = new Jewels();
      this.jewels.onload = this.jewelsLoaded;
    }

    JewelClone.prototype.realWidth = function() {
      return window.innerWidth * window.devicePixelRatio;
    };

    JewelClone.prototype.realHeight = function() {
      return window.innerHeight * window.devicePixelRatio;
    };

    JewelClone.prototype.aspect = function() {
      return window.innerWidth / window.innerHeight;
    };

    JewelClone.prototype.initThree = function() {
      document.body.style.zoom = 1 / window.devicePixelRatio;
      this.scene = new THREE.Scene();
      this.camera = new THREE.OrthographicCamera(0, this.realWidth(), this.realHeight(), 0, 0, 1000);
      this.camera.position.z = 500;
      this.camera.updateProjectionMatrix();
      this.renderer = new THREE.WebGLRenderer({
        antialias: true
      });
      this.renderer.setSize(this.realWidth(), this.realHeight());
      document.body.appendChild(this.renderer.domElement);
      this.scene.add(new THREE.AmbientLight(0x555555));
      this.light = new THREE.DirectionalLight(0xffffff, 1);
      this.light.position.z = 100;
      this.light.position.y = 10;
      return this.scene.add(this.light);
    };

    JewelClone.prototype.jewelsLoaded = function() {
      var d, offset, s, top_offset;
      this.logger.log("jewels loaded");
      d = 8;
      s = this.realWidth() / d;
      top_offset = (this.realHeight() - this.realWidth()) / 2;
      offset = -s * ((d / 2) - 0.5);
      this.board = new Grid(d, d, this.jewels);
      this.board.object.scale.multiplyScalar(s);
      this.scene.add(this.board.object);
      return this.renderLoop(0);
    };

    JewelClone.prototype.updateLight = function() {
      this.light.position.x = this.input.orientation.gamma * -1;
      return this.light.position.y = this.input.orientation.beta;
    };

    JewelClone.prototype.renderLoop = function(t) {
      requestAnimationFrame(this.renderLoop);
      this.fps.update(t);
      this.updateLight();
      return this.renderer.render(this.scene, this.camera);
    };

    return JewelClone;

  })();

  Jewel = (function() {
    function Jewel(id) {
      this.modelLoaded = bind(this.modelLoaded, this);
      var color;
      this.loaded = false;
      this.id = id;
      this.scalefactor = 1.25;
      this.colors = ['red', 'white', 'lime', 'blue', 'orange', 'purple', 'teal', 'deeppink'];
      color = this.randomColor();
      this.material = new THREE.MeshPhongMaterial({
        color: color,
        ambient: color,
        shininess: 50
      });
      this.loadModel();
    }

    Jewel.prototype.randomColor = function() {
      return this.colors[Math.floor(Math.random() * this.colors.length)];
    };

    Jewel.prototype.build = function() {
      return new THREE.Mesh(this.geometry, this.material);
    };

    Jewel.prototype.modelUrl = function() {
      return "models/" + this.id + ".json";
    };

    Jewel.prototype.modelLoaded = function() {
      var geometry, json, jsonloader, r, rx, s;
      jsonloader = new THREE.JSONLoader();
      json = JSON.parse(this.req.responseText);
      geometry = jsonloader.parse(json.geometries[0].data).geometry;
      this.geometry = new THREE.BufferGeometry().fromGeometry(geometry);
      rx = new THREE.Matrix4().makeRotationX(Math.PI / 2);
      s = new THREE.Matrix4().makeScale(this.scalefactor, this.scalefactor, this.scalefactor);
      r = new THREE.Matrix4().multiplyMatrices(rx, s);
      this.geometry.applyMatrix(r);
      this.loaded = true;
      return this.onload();
    };

    Jewel.prototype.loadModel = function() {
      this.req = new XMLHttpRequest();
      this.req.onload = this.modelLoaded;
      this.req.open("GET", this.modelUrl());
      return this.req.send();
    };

    Jewel.prototype.onload = function() {};

    return Jewel;

  })();

  Jewels = (function() {
    function Jewels() {
      this.jewelLoaded = bind(this.jewelLoaded, this);
      var i, jewel, len, ref;
      this.loaded = false;
      this.list = ['archaic2', 'asterism', 'button', 'litehouse', 'novice3', 'novice6', 'starcut', 'arrow', 'cascade', 'novice1', 'novice5', 'novice8'];
      this.objects = this.load();
      ref = this.objects;
      for (i = 0, len = ref.length; i < len; i++) {
        jewel = ref[i];
        jewel.onload = this.jewelLoaded;
      }
    }

    Jewels.prototype.random = function() {
      return this.objects[Math.floor(Math.random() * this.objects.length)].build();
    };

    Jewels.prototype.load = function() {
      var i, id, len, ref, results;
      ref = this.list;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        id = ref[i];
        results.push(new Jewel(id));
      }
      return results;
    };

    Jewels.prototype.allLoaded = function() {
      var i, jewel, len, ref;
      ref = this.objects;
      for (i = 0, len = ref.length; i < len; i++) {
        jewel = ref[i];
        if (!jewel.loaded) {
          return false;
        }
      }
      return true;
    };

    Jewels.prototype.jewelLoaded = function() {
      if (this.allLoaded()) {
        return this.onload();
      }
    };

    Jewels.prototype.onload = function() {};

    return Jewels;

  })();

  Logger = (function() {
    function Logger() {
      this.loglines = [];
    }

    Logger.prototype.log = function(text) {
      this.loglines.push(text);
      return document.getElementById('log').innerText = this.loglines.join("\n");
    };

    return Logger;

  })();

}).call(this);
